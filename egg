local replicatedStorage = game:GetService("ReplicatedStorage")
local collectionService = game:GetService("CollectionService")
local players = game:GetService("Players")
local teleportService = game:GetService("TeleportService")

local localPlayer = players.LocalPlayer
local PLACE_ID = 126884695634066 -- Remplace par ton vrai diddy blud game
local TARGET_PET_NAME = "Raccoon"

local hatchFunction = getupvalue(getupvalue(getconnections(replicatedStorage.GameEvents.PetEggService.OnClientEvent)[1].Function, 1), 2)
local eggModels = getupvalue(hatchFunction, 1)
local eggPets = getupvalue(hatchFunction, 2)

local espCache = {}
local activeEggs = {}

local function CreateEspGui(object, text)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "PetEggESP"
    billboard.Adornee = object:FindFirstChildWhichIsA("BasePart") or object.PrimaryPart or object
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true

    local label = Instance.new("TextLabel")
    label.Parent = billboard
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextStrokeTransparency = 0
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold

    billboard.Parent = object
    return billboard
end

local function AddEgg(object)
    if object:GetAttribute("OWNER") ~= localPlayer.Name then return end

    local objectId = object:GetAttribute("OBJECT_UUID")
    local petName = eggPets[objectId]
    if not objectId or not petName then return end

    local eggName = object:GetAttribute("EggName")
    local esp = CreateEspGui(object, `{eggName} | {petName}`)
    espCache[objectId] = esp
    activeEggs[objectId] = petName
end

local function RemoveEgg(object)
    if object:GetAttribute("OWNER") ~= localPlayer.Name then return end
    local objectId = object:GetAttribute("OBJECT_UUID")
    if espCache[objectId] then
        espCache[objectId]:Destroy()
        espCache[objectId] = nil
    end
    activeEggs[objectId] = nil
end

local function CheckAllEggs()
    task.wait(1) -- attendre que les diddy eggs

    for _, petName in pairs(activeEggs) do
        if petName == TARGET_PET_NAME then
            warn("Y'a Un Raccoon Diddy Blud quitte pas le server")
            return
        end
    end

    warn("Y'a pas le Raccoon DiddyBlud")
    teleportService:TeleportToPlaceInstance(PLACE_ID, game.JobId, localPlayer)
end


for _, object in collectionService:GetTagged("PetEggServer") do
    task.spawn(AddEgg, object)
end

collectionService:GetInstanceAddedSignal("PetEggServer"):Connect(AddEgg)
collectionService:GetInstanceRemovedSignal("PetEggServer"):Connect(RemoveEgg)

task.delay(2, CheckAllEggs)
